# Aiken FAIRWAY Staking Contract

This project implements a parameterized staking contract using the [Aiken](https://aiken-lang.org/) smart contract language for the Cardano blockchain.

## Overview

This validator allows users (Curators or Issuers) to stake FAIRWAY tokens. The staking is associated with a Decentralized Identifier (DID) token, which must be present as a reference input during the staking action. The contract enforces minimum stake amounts based on the user's role (Curator or Issuer), configurable via an environment file. A designated authority can slash the stake under certain conditions.

## Features

*   **Role-Based Staking:** Supports distinct roles (Curator, Issuer) with potentially different minimum staking requirements.
*   **DID Association:** Requires a specific DID token (identified by its Policy ID) as a reference input when staking, linking the stake to an identity.
*   **Configurable Minimums:** Minimum stake amounts (`min_curator_stake`, `min_issuer_stake`) are defined in the `env/default.ak` configuration file, allowing adjustment without recompiling the core validator logic (though requiring a rebuild).
*   **Parameterized:** Key constants (`fairway_token_policy`, `did_token_policy`, `slashing_authority`) are provided as parameters when applying the blueprint, making the script reusable and secure.
*   **Stake Slashing:** Allows a designated slashing authority (identified by their `VerificationKeyHash`) to remove a user's stake.
*   **Withdrawal:** Allows the original staker to withdraw their full stake.

## Project Structure

*   `aiken.toml`: Project manifest file, defines dependencies and project metadata.
*   `validators/staking.ak`: The core Aiken validator script implementing the staking logic.
*   `env/default.ak`: Default environment configuration file defining `min_curator_stake` and `min_issuer_stake`.
*   `tests/`: (Optional) Directory for unit tests.
*   `lib/`: (Optional) Directory for shared Aiken library modules.
*   `build/`: Contains build artifacts generated by Aiken (ignored by git).
*   `plutus.json`: The compiled Plutus blueprint generated by `aiken build`.

## Validator Details

### Parameters

These are provided *before* applying the blueprint using off-chain tools. They become part of the validator hash and thus the script address.

*   `fairway_token_policy: PolicyId` - The Policy ID of the FAIRWAY token being staked.
*   `did_token_policy: PolicyId` - The Policy ID of the required DID reference token.
*   `slashing_authority: VerificationKeyHash` - The verification key hash of the entity authorized to slash stakes.

### Environment Configuration (`env/default.ak`)

These constants define the minimum required stake amounts for each role. They are compiled into the script based on the environment.

```aiken
// Environment specific configuration

pub const min_curator_stake: Int = 10_000_000 // Example: 10M tokens
pub const min_issuer_stake: Int = 5_000_000  // Example: 5M tokens 
```

### Datum (`StakeDatum`)

This structure holds the state for a specific stake. It must be provided, likely as `InlineDatum`, when locking funds at the script address.

```aiken
pub type StakeDatum {
  staker: VerificationKeyHash,
  issuer_did_hash: ByteArray, // Hash identifying the specific DID/Issuer context
  role: StakeRole, // Curator or Issuer
  staked_amount: Int, // Amount of FAIRWAY token staked
}
```

### Redeemer (`StakeAction`)

This defines the actions the user intends to perform when interacting with a staked UTxO.

```aiken
pub type StakeAction {
  Stake // Initial staking action (although datum is set at lock time)
  Withdraw // Staker withdraws their stake
  Slash // Slashing authority removes the stake
}
```

### Logic Summary

*   **`spend` Handler:** The main entry point, triggered when attempting to spend a UTxO locked at the script address.
    *   Requires the datum (`StakeDatum`) to be present (`expect Some(datum) = datum_opt`).
    *   Dispatches to `handle_stake`, `handle_withdraw`, or `handle_slash` based on the provided `StakeAction` redeemer.
*   **`handle_stake`:** (Note: Actual locking happens in a previous Tx)
    *   Checks staker signature.
    *   Checks for the presence of exactly one DID token (policy `did_token_policy`) in reference inputs.
    *   Checks that the output back to the script contains the correct `staked_amount` of FAIRWAY token and the correct datum.
    *   Checks that `staked_amount` meets the minimum requirement (`min_curator_stake` or `min_issuer_stake` from `env/config`) based on the `role`.
*   **`handle_withdraw`:**
    *   Checks staker signature.
    *   Checks the input UTxO contains the correct `staked_amount`.
    *   Validates that the full `staked_amount` of FAIRWAY token is returned to the staker's address.
*   **`handle_slash`:**
    *   Checks slashing authority signature (using the `slashing_authority` parameter).
    *   Checks the input UTxO contains the correct `staked_amount`.
    *   Validates that **no** FAIRWAY tokens are returned to the original staker.

## Development

### Prerequisites

*   [Aiken Installation](https://aiken-lang.org/installation-guide)

### Commands

*   **Build:** `aiken build` (Compiles the validator and outputs `plutus.json`)
*   **Check & Test:** `aiken check` (Compiles, type-checks, and runs tests if any exist in `tests/`)

## Off-Chain Integration (High-Level)

1.  **Compile & Parameterize:** Run `aiken build`. Use an off-chain tool to apply the `fairway_token_policy`, `did_token_policy`, and `slashing_authority` parameters to the generated `plutus.json` blueprint to get the final script.
2.  **Calculate Address:** Derive the script address from the final parameterized script.
3.  **Locking Funds (Staking):** Construct a transaction that sends the `staked_amount` of FAIRWAY tokens to the script address. This transaction output must include the `StakeDatum` as `InlineDatum`.
4.  **Referencing DID Token:** The staking transaction *must* include a UTxO containing the specific DID token (matching `did_token_policy`) as a *reference input*. It is *not* spent.
5.  **Withdrawing Stake:** The staker constructs a transaction spending the script UTxO, providing the `Withdraw` redeemer, their signature, and ensuring the funds are returned to them.
6.  **Slashing Stake:** The slashing authority constructs a transaction spending the script UTxO, providing the `Slash` redeemer and their signature. The funds are *not* returned to the staker (they can be sent anywhere else, e.g., a treasury or burn address).

## Security Considerations

*   **Datum Validation:** Off-chain code must correctly construct the initial `StakeDatum`.
*   **Parameter Application:** Securely manage the parameterization process.
*   **Token Identification:** The security relies on the uniqueness of the Policy IDs.
*   **DID Reference Input:** Ensure the correct DID token UTxO is referenced during staking.
*   **Slashing Authority Key:** Protect the private key corresponding to the `slashing_authority` hash.
*   **Minimum Stake Configuration:** Ensure the values in `env/default.ak` are appropriate for the target network/deployment.
*   **Audit:** This code has not been professionally audited. Use with caution and consider a formal audit before deploying significant value.
